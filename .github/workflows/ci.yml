name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: ${{ matrix.os }} / ${{ matrix.compiler }} / ${{ matrix.build_type }}

    strategy:
      fail-fast: false   # Run all matrix jobs even if one fails
      matrix:
        os: [ ubuntu-latest ]
        compiler:
          - { cc: gcc,   cxx: g++   }
          - { cc: clang, cxx: clang++ }
        build_type: [ Debug, Release ]

    runs-on: ${{ matrix.os }}

    steps:
      # -----------------------------------------------------------------------
      # 1. Check out the repo
      # -----------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 2. Install the requested compiler
      # -----------------------------------------------------------------------
      - name: Install compilers
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y gcc g++ clang

      # -----------------------------------------------------------------------
      # 3. Configure with CMake
      #    - Benchmarks are off (they fail on some runners due to regex detection)
      #    - Debug builds get Address Sanitizer + Undefined Behavior Sanitizer
      # -----------------------------------------------------------------------
      - name: Configure CMake
        working-directory: cpp
        env:
          CC:  ${{ matrix.compiler.cc }}
          CXX: ${{ matrix.compiler.cxx }}
        run: |
          cmake -B build \
                -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -DBUILD_BENCHMARKS=OFF

      # -----------------------------------------------------------------------
      # 4. Build
      # -----------------------------------------------------------------------
      - name: Build
        working-directory: cpp
        run: cmake --build build --parallel

      # -----------------------------------------------------------------------
      # 5. Run tests
      #    --output-on-failure: print full output only for failing tests
      # -----------------------------------------------------------------------
      - name: Run tests
        working-directory: cpp/build
        run: ctest --output-on-failure
